{% extends "base.html" %}

{% block title %}Category Management - AutoSpareHub Admin{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" rel="stylesheet">
<style>
    .categories-container {
        animation: fadeIn 0.5s ease-out;
    }
    
    .category-tree-container {
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 20px;
        background: white;
        min-height: 500px;
    }
    
    .jstree-default .jstree-clicked {
        background: rgba(10, 31, 68, 0.1) !important;
        box-shadow: none !important;
        color: #0A1F44 !important;
    }
    
    .category-actions {
        position: absolute;
        right: 10px;
        top: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .category-item:hover .category-actions {
        opacity: 1;
    }
    
    .category-badge {
        font-size: 0.7rem;
        padding: 2px 8px;
        margin-left: 5px;
    }
    
    .category-icon {
        width: 40px;
        height: 40px;
        background: #f8f9fa;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #0A1F44;
        font-size: 18px;
    }
    
    .category-stats {
        display: flex;
        gap: 10px;
        margin-top: 5px;
    }
    
    .stat-item {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }
    
    .empty-state-icon {
        font-size: 60px;
        color: #dee2e6;
        margin-bottom: 20px;
    }
    
    .drag-handle {
        cursor: move;
        color: #6c757d;
        margin-right: 10px;
    }
    
    .sortable-ghost {
        opacity: 0.4;
        background: #f8f9fa;
    }
    
    .sortable-chosen {
        background: rgba(10, 31, 68, 0.05);
    }
    
    .sortable-drag {
        opacity: 0.8;
        transform: rotate(5deg);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 categories-container">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Category Management</h1>
            <p class="text-muted mb-0">Organize and manage product categories</p>
        </div>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                <i class="fas fa-plus me-2"></i>Add New Category
            </button>
            <button class="btn btn-outline-secondary ms-2" id="expand-all">
                <i class="fas fa-expand me-2"></i>Expand All
            </button>
            <button class="btn btn-outline-secondary ms-2" id="collapse-all">
                <i class="fas fa-compress me-2"></i>Collapse All
            </button>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Categories</h6>
                            <h2 class="mb-0">{{ categories|length }}</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-folder-open fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Active Products</h6>
                            <h2 class="mb-0">{{ total_products }}</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-box-open fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-dark-50 mb-1">Main Categories</h6>
                            <h2 class="mb-0">{{ main_categories|length }}</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-layer-group fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Subcategories</h6>
                            <h2 class="mb-0">{{ subcategories|length }}</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-sitemap fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="row">
        <!-- Category Tree -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-sitemap me-2"></i>Category Hierarchy
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-light" id="tree-view">
                            <i class="fas fa-project-diagram"></i>
                        </button>
                        <button class="btn btn-light active" id="list-view">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="category-tree-container" id="category-tree">
                        {% if categories %}
                        <div id="category-list" class="list-view">
                            {% for category in categories %}
                            {% if not category.parent_id %}
                            {% include 'admin/components/category_item.html' %}
                            {% endif %}
                            {% endfor %}
                        </div>
                        <div id="category-jstree" class="tree-view" style="display: none;"></div>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-folder-open"></i>
                            </div>
                            <h4 class="text-muted mb-3">No Categories Found</h4>
                            <p class="text-muted mb-4">Get started by creating your first category</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" 
                                    data-bs-target="#addCategoryModal">
                                <i class="fas fa-plus me-2"></i>Create Category
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Category Details & Actions -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" 
                                data-bs-target="#bulkUploadModal">
                            <i class="fas fa-upload me-2"></i>Bulk Upload
                        </button>
                        <button class="btn btn-outline-secondary" id="export-categories">
                            <i class="fas fa-download me-2"></i>Export Categories
                        </button>
                        <button class="btn btn-outline-danger" id="delete-selected" disabled>
                            <i class="fas fa-trash me-2"></i>Delete Selected
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Selected Category Details -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Category Details</h5>
                </div>
                <div class="card-body">
                    <div id="category-details" class="empty-details">
                        <div class="text-center py-4">
                            <i class="fas fa-mouse-pointer fa-2x text-muted mb-3"></i>
                            <p class="text-muted mb-0">Select a category to view details</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Category Stats -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Categories with products</span>
                            <span class="badge bg-primary rounded-pill">{{ categories_with_products }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Empty categories</span>
                            <span class="badge bg-warning rounded-pill">{{ empty_categories }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Maximum depth</span>
                            <span class="badge bg-info rounded-pill">{{ max_depth }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Last updated</span>
                            <small class="text-muted">{{ last_updated }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Add New Category</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="addCategoryForm" method="POST" action="{{ url_for('admin.add_category') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category Name *</label>
                            <input type="text" class="form-control" name="name" required
                                   placeholder="Enter category name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Slug *</label>
                            <input type="text" class="form-control" name="slug" required
                                   placeholder="auto-generated-slug">
                            <small class="text-muted">URL-friendly version of the name</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Parent Category</label>
                        <select class="form-select" name="parent_id">
                            <option value="">No Parent (Main Category)</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"
                                  placeholder="Describe this category..."></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Icon Class</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-icons"></i></span>
                                <input type="text" class="form-control" name="icon"
                                       placeholder="fas fa-cog">
                            </div>
                            <small class="text-muted">Font Awesome icon class</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Display Order</label>
                            <input type="number" class="form-control" name="display_order" value="0"
                                   min="0" max="100">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" id="is_active" checked>
                            <label class="form-check-label" for="is_active">
                                Active (Visible on website)
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Category Image</label>
                        <input type="file" class="form-control" name="image" accept="image/*">
                        <small class="text-muted">Optional: Upload category banner image</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Category
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Edit Category</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCategoryForm" method="POST">
                <div class="modal-body">
                    <div id="editCategoryContent">
                        <!-- Content will be loaded dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Update Category
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Upload Modal -->
<div class="modal fade" id="bulkUploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Bulk Upload Categories</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Upload a CSV file with categories. Download template for reference.
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Download Template</label>
                    <div>
                        <a href="#" class="btn btn-outline-primary btn-sm" id="download-template">
                            <i class="fas fa-file-download me-2"></i>Download CSV Template
                        </a>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Upload CSV File *</label>
                    <input type="file" class="form-control" id="csvFile" accept=".csv">
                    <small class="text-muted">File should have columns: name, slug, parent_slug, description</small>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="overwrite_existing">
                        <label class="form-check-label" for="overwrite_existing">
                            Overwrite existing categories with same slug
                        </label>
                    </div>
                </div>
                
                <div id="upload-preview" class="d-none">
                    <h6>Preview</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead id="preview-head"></thead>
                            <tbody id="preview-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="start-upload" disabled>
                    <i class="fas fa-upload me-2"></i>Upload Categories
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone.
                </div>
                <p id="delete-message">Are you sure you want to delete this category?</p>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="delete_subcategories">
                    <label class="form-check-label" for="delete_subcategories">
                        Also delete all subcategories
                    </label>
                </div>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="move_products">
                    <label class="form-check-label" for="move_products">
                        Move products to another category
                    </label>
                </div>
                <div class="mt-2 d-none" id="target-category-container">
                    <select class="form-select" id="target_category">
                        <option value="">Select target category</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete">
                    <i class="fas fa-trash me-2"></i>Delete Category
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Category Item Template -->
<script type="text/html" id="category-item-template">
    <div class="category-item card mb-2" data-category-id="{id}">
        <div class="card-body">
            <div class="d-flex align-items-center">
                <div class="drag-handle me-3">
                    <i class="fas fa-grip-vertical"></i>
                </div>
                <div class="category-icon me-3">
                    <i class="{icon}"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">{name}
                                <span class="badge bg-secondary category-badge">{product_count} products</span>
                            </h6>
                            <small class="text-muted">/{slug}</small>
                        </div>
                        <div class="category-actions">
                            <button class="btn btn-sm btn-outline-primary edit-category" 
                                    data-category-id="{id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-category" 
                                    data-category-id="{id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="category-stats">
                        <span class="stat-item">
                            <i class="fas fa-layer-group me-1"></i>
                            {subcategory_count} subcategories
                        </span>
                        <span class="stat-item">
                            <i class="fas fa-eye me-1"></i>
                            {status}
                        </span>
                        <span class="stat-item">
                            <i class="fas fa-sort-numeric-down me-1"></i>
                            Order: {display_order}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        {subcategories}
    </div>
</script>

<!-- Category Details Template -->
<script type="text/html" id="category-details-template">
    <div class="category-details">
        <div class="d-flex align-items-center mb-3">
            <div class="category-icon-lg me-3">
                <i class="{icon} fa-2x"></i>
            </div>
            <div>
                <h4 class="mb-0">{name}</h4>
                <small class="text-muted">/{slug}</small>
            </div>
        </div>
        
        <div class="mb-3">
            <strong>Description:</strong>
            <p class="mb-0">{description}</p>
        </div>
        
        <div class="row mb-3">
            <div class="col-6">
                <strong>Status:</strong>
                <div>
                    <span class="badge {status_class}">{status_text}</span>
                </div>
            </div>
            <div class="col-6">
                <strong>Display Order:</strong>
                <div>{display_order}</div>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-6">
                <strong>Products:</strong>
                <div class="h5">{product_count}</div>
            </div>
            <div class="col-6">
                <strong>Subcategories:</strong>
                <div class="h5">{subcategory_count}</div>
            </div>
        </div>
        
        <div class="mb-3">
            <strong>Parent Category:</strong>
            <div>{parent_category}</div>
        </div>
        
        <div class="mb-3">
            <strong>Created:</strong>
            <div>{created_at}</div>
        </div>
        
        <div class="mb-3">
            <strong>Last Updated:</strong>
            <div>{updated_at}</div>
        </div>
        
        <div class="d-grid gap-2 mt-4">
            <button class="btn btn-primary edit-category" data-category-id="{id}">
                <i class="fas fa-edit me-2"></i>Edit Category
            </button>
            <button class="btn btn-outline-secondary" onclick="viewProducts({id})">
                <i class="fas fa-box-open me-2"></i>View Products
            </button>
        </div>
    </div>
</script>

<style>
    .category-icon-lg {
        width: 60px;
        height: 60px;
        background: #f8f9fa;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #0A1F44;
    }
    
    .subcategory-container {
        margin-left: 60px;
        margin-top: 10px;
        border-left: 2px solid #dee2e6;
        padding-left: 20px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize category tree
        initCategoryTree();
        
        // Initialize event handlers
        initEventHandlers();
        
        // Initialize drag and drop
        initSortable();
        
        // Load category statistics
        loadCategoryStats();
    });
    
    /**
     * Initialize category tree view
     */
    function initCategoryTree() {
        const treeData = {{ categories_json|safe }};
        
        $('#category-jstree').jstree({
            'core': {
                'data': treeData,
                'themes': {
                    'responsive': false,
                    'variant': 'large',
                    'stripes': true
                },
                'check_callback': true
            },
            'plugins': ['dnd', 'contextmenu', 'wholerow'],
            'contextmenu': {
                'items': function(node) {
                    return {
                        'create': {
                            'label': 'Create Subcategory',
                            'action': function(data) {
                                const inst = $.jstree.reference(data.reference);
                                const obj = inst.get_node(data.reference);
                                openAddCategoryModal(obj.id);
                            }
                        },
                        'rename': {
                            'label': 'Rename',
                            'action': function(data) {
                                const inst = $.jstree.reference(data.reference);
                                inst.edit(data.reference);
                            }
                        },
                        'remove': {
                            'label': 'Delete',
                            'action': function(data) {
                                const inst = $.jstree.reference(data.reference);
                                const obj = inst.get_node(data.reference);
                                confirmDeleteCategory(obj.id);
                            }
                        }
                    };
                }
            }
        }).on('select_node.jstree', function(e, data) {
            const categoryId = data.node.id;
            loadCategoryDetails(categoryId);
        });
    }
    
    /**
     * Initialize event handlers
     */
    function initEventHandlers() {
        // View toggle
        $('#tree-view').on('click', function() {
            $(this).addClass('active');
            $('#list-view').removeClass('active');
            $('#category-list').hide();
            $('#category-jstree').show();
        });
        
        $('#list-view').on('click', function() {
            $(this).addClass('active');
            $('#tree-view').removeClass('active');
            $('#category-jstree').hide();
            $('#category-list').show();
        });
        
        // Expand/Collapse all
        $('#expand-all').on('click', function() {
            $('#category-jstree').jstree('open_all');
        });
        
        $('#collapse-all').on('click', function() {
            $('#category-jstree').jstree('close_all');
        });
        
        // Add category form
        $('#addCategoryForm').on('submit', function(e) {
            e.preventDefault();
            submitCategoryForm(this, 'add');
        });
        
        // Edit category form
        $('#editCategoryForm').on('submit', function(e) {
            e.preventDefault();
            submitCategoryForm(this, 'edit');
        });
        
        // Category name auto-slug
        $('input[name="name"]').on('input', function() {
            const name = $(this).val();
            const slug = name.toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/--+/g, '-')
                .trim();
            $('input[name="slug"]').val(slug);
        });
        
        // CSV file upload preview
        $('#csvFile').on('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                previewCSV(file);
            }
        });
        
        // Download template
        $('#download-template').on('click', function(e) {
            e.preventDefault();
            downloadCSVTemplate();
        });
        
        // Start bulk upload
        $('#start-upload').on('click', function() {
            bulkUploadCategories();
        });
        
        // Delete category
        $('#confirm-delete').on('click', function() {
            deleteCategory();
        });
        
        // Move products toggle
        $('#move_products').on('change', function() {
            if (this.checked) {
                $('#target-category-container').removeClass('d-none');
            } else {
                $('#target-category-container').addClass('d-none');
            }
        });
        
        // Export categories
        $('#export-categories').on('click', function() {
            exportCategories();
        });
    }
    
    /**
     * Initialize sortable drag and drop
     */
    function initSortable() {
        const categoryList = document.getElementById('category-list');
        if (categoryList) {
            new Sortable(categoryList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                handle: '.drag-handle',
                onEnd: function(evt) {
                    updateCategoryOrder();
                }
            });
        }
    }
    
    /**
     * Submit category form
     */
    function submitCategoryForm(form, action) {
        const formData = new FormData(form);
        const url = action === 'add' ? 
            '{{ url_for("admin.add_category") }}' : 
            form.getAttribute('action');
        
        // Show loading
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
        submitBtn.disabled = true;
        
        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                $('#' + action + 'CategoryModal').modal('hide');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showNotification(data.message, 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred', 'error');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    }
    
    /**
     * Load category details
     */
    function loadCategoryDetails(categoryId) {
        fetch(`/admin/api/categories/${categoryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const template = document.getElementById('category-details-template').innerHTML;
                const html = template
                    .replace(/{id}/g, data.category.id)
                    .replace(/{name}/g, data.category.name)
                    .replace(/{slug}/g, data.category.slug)
                    .replace(/{icon}/g, data.category.icon || 'fas fa-folder')
                    .replace(/{description}/g, data.category.description || 'No description')
                    .replace(/{status_class}/g, data.category.is_active ? 'bg-success' : 'bg-secondary')
                    .replace(/{status_text}/g, data.category.is_active ? 'Active' : 'Inactive')
                    .replace(/{display_order}/g, data.category.display_order)
                    .replace(/{product_count}/g, data.category.product_count)
                    .replace(/{subcategory_count}/g, data.category.subcategory_count)
                    .replace(/{parent_category}/g, data.category.parent_name || 'None')
                    .replace(/{created_at}/g, new Date(data.category.created_at).toLocaleDateString())
                    .replace(/{updated_at}/g, new Date(data.category.updated_at).toLocaleDateString());
                
                document.getElementById('category-details').innerHTML = html;
                
                // Enable delete selected button
                document.getElementById('delete-selected').disabled = false;
                
                // Store selected category
                window.selectedCategoryId = categoryId;
            }
        })
        .catch(error => {
            console.error('Error loading category details:', error);
        });
    }
    
    /**
     * Open edit category modal
     */
    function openEditCategoryModal(categoryId) {
        fetch(`/admin/api/categories/${categoryId}/edit`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const content = `
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category Name *</label>
                            <input type="text" class="form-control" name="name" 
                                   value="${data.category.name}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Slug *</label>
                            <input type="text" class="form-control" name="slug" 
                                   value="${data.category.slug}" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Parent Category</label>
                        <select class="form-select" name="parent_id">
                            <option value="">No Parent (Main Category)</option>
                            ${data.categories.map(cat => `
                                <option value="${cat.id}" ${cat.id == data.category.parent_id ? 'selected' : ''}>
                                    ${cat.name}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3">${data.category.description || ''}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Icon Class</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-icons"></i></span>
                                <input type="text" class="form-control" name="icon"
                                       value="${data.category.icon || ''}">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Display Order</label>
                            <input type="number" class="form-control" name="display_order" 
                                   value="${data.category.display_order}">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" id="edit_is_active" ${data.category.is_active ? 'checked' : ''}>
                            <label class="form-check-label" for="edit_is_active">
                                Active (Visible on website)
                            </label>
                        </div>
                    </div>
                    
                    <input type="hidden" name="category_id" value="${categoryId}">
                `;
                
                document.getElementById('editCategoryContent').innerHTML = content;
                document.getElementById('editCategoryForm').setAttribute('action', `/admin/categories/edit/${categoryId}`);
                $('#editCategoryModal').modal('show');
            }
        })
        .catch(error => {
            console.error('Error loading category:', error);
            showNotification('Failed to load category', 'error');
        });
    }
    
    /**
     * Confirm delete category
     */
    function confirmDeleteCategory(categoryId) {
        window.deleteCategoryId = categoryId;
        
        fetch(`/admin/api/categories/${categoryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const message = `Are you sure you want to delete "${data.category.name}"?`;
                document.getElementById('delete-message').textContent = message;
                $('#deleteCategoryModal').modal('show');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    /**
     * Delete category
     */
    function deleteCategory() {
        const deleteSubcategories = document.getElementById('delete_subcategories').checked;
        const moveProducts = document.getElementById('move_products').checked;
        const targetCategory = document.getElementById('target_category').value;
        
        const data = {
            delete_subcategories: deleteSubcategories,
            move_products: moveProducts,
            target_category_id: moveProducts ? targetCategory : null
        };
        
        fetch(`/admin/categories/delete/${window.deleteCategoryId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                $('#deleteCategoryModal').modal('hide');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to delete category', 'error');
        });
    }
    
    /**
     * Preview CSV file
     */
    function previewCSV(file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const content = e.target.result;
            const lines = content.split('\n');
            const headers = lines[0].split(',');
            
            // Show preview headers
            let headerHtml = '<tr>';
            headers.forEach(header => {
                headerHtml += `<th>${header.trim()}</th>`;
            });
            headerHtml += '</tr>';
            document.getElementById('preview-head').innerHTML = headerHtml;
            
            // Show preview rows (first 5)
            let bodyHtml = '';
            for (let i = 1; i < Math.min(6, lines.length); i++) {
                if (lines[i].trim()) {
                    const cells = lines[i].split(',');
                    bodyHtml += '<tr>';
                    cells.forEach(cell => {
                        bodyHtml += `<td>${cell.trim()}</td>`;
                    });
                    bodyHtml += '</tr>';
                }
            }
            document.getElementById('preview-body').innerHTML = bodyHtml;
            
            // Show preview and enable upload button
            document.getElementById('upload-preview').classList.remove('d-none');
            document.getElementById('start-upload').disabled = false;
        };
        
        reader.readAsText(file);
    }
    
    /**
     * Download CSV template
     */
    function downloadCSVTemplate() {
        const template = `name,slug,parent_slug,description,icon,display_order,is_active
Engine Parts,engine-parts,,All engine related parts,fas fa-cog,1,true
Brake System,brake-system,,Brake pads, discs, fluids,fas fa-stop-circle,2,true
Suspension,suspension,,Shock absorbers, springs,fas fa-car-side,3,true
Brake Pads,brake-pads,brake-system,Brake pads for various models,fas fa-stop-circle,1,true
Brake Discs,brake-discs,brake-system,Brake discs/rotors,fas fa-stop-circle,2,true`;
        
        const blob = new Blob([template], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'category_template.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }
    
    /**
     * Bulk upload categories
     */
    function bulkUploadCategories() {
        const fileInput = document.getElementById('csvFile');
        const overwrite = document.getElementById('overwrite_existing').checked;
        
        if (!fileInput.files.length) {
            showNotification('Please select a CSV file', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('overwrite', overwrite);
        
        const button = document.getElementById('start-upload');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
        button.disabled = true;
        
        fetch('/admin/categories/bulk-upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`${data.created} categories created, ${data.updated} updated`, 'success');
                $('#bulkUploadModal').modal('hide');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showNotification(data.message, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Upload failed', 'error');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
    
    /**
     * Export categories
     */
    function exportCategories() {
        fetch('/admin/categories/export')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const csv = convertToCSV(data.categories);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'categories_export.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showNotification('Categories exported successfully', 'success');
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Export failed', 'error');
        });
    }
    
    /**
     * Convert data to CSV
     */
    function convertToCSV(data) {
        const headers = ['id', 'name', 'slug', 'parent_id', 'description', 'icon', 'display_order', 'is_active', 'product_count'];
        const rows = data.map(item => [
            item.id,
            `"${item.name}"`,
            item.slug,
            item.parent_id || '',
            `"${item.description || ''}"`,
            item.icon || '',
            item.display_order,
            item.is_active ? 'true' : 'false',
            item.product_count
        ].join(','));
        
        return [headers.join(','), ...rows].join('\n');
    }
    
    /**
     * Update category order after drag and drop
     */
    function updateCategoryOrder() {
        const order = [];
        document.querySelectorAll('.category-item').forEach((item, index) => {
            const categoryId = item.dataset.categoryId;
            order.push({
                id: categoryId,
                display_order: index + 1
            });
        });
        
        fetch('/admin/categories/update-order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ order: order })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Category order updated');
            }
        })
        .catch(error => {
            console.error('Error updating order:', error);
        });
    }
    
    /**
     * Load category statistics
     */
    function loadCategoryStats() {
        // This would typically fetch from an API endpoint
        console.log('Loading category statistics...');
    }
    
    /**
     * View products in category
     */
    function viewProducts(categoryId) {
        window.location.href = `/admin/products?category_id=${categoryId}`;
    }
    
    /**
     * Show notification
     */
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show`;
        notification.innerHTML = `
            <i class="fas fa-${getNotificationIcon(type)} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    function getNotificationIcon(type) {
        const icons = {
            'success': 'check-circle',
            'error': 'exclamation-circle',
            'warning': 'exclamation-triangle',
            'info': 'info-circle'
        };
        return icons[type] || 'info-circle';
    }
    
    // Event delegation for dynamic elements
    document.addEventListener('click', function(e) {
        // Edit category button
        if (e.target.closest('.edit-category')) {
            const button = e.target.closest('.edit-category');
            const categoryId = button.dataset.categoryId;
            openEditCategoryModal(categoryId);
        }
        
        // Delete category button
        if (e.target.closest('.delete-category')) {
            const button = e.target.closest('.delete-category');
            const categoryId = button.dataset.categoryId;
            confirmDeleteCategory(categoryId);
        }
        
        // Category item click
        if (e.target.closest('.category-item')) {
            const item = e.target.closest('.category-item');
            const categoryId = item.dataset.categoryId;
            loadCategoryDetails(categoryId);
            
            // Remove active class from all items
            document.querySelectorAll('.category-item').forEach(el => {
                el.classList.remove('active');
            });
            
            // Add active class to clicked item
            item.classList.add('active');
        }
    });
</script>
{% endblock %}