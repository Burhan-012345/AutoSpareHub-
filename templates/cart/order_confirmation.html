{% extends "base.html" %}

{% block title %}Order Confirmation - AutoSpareHub{% endblock %}

{% block extra_css %}
<style>
    .order-confirmation-container {
        animation: fadeIn 0.8s ease-out;
    }
    
    .success-animation {
        text-align: center;
        margin: 40px 0;
    }
    
    .checkmark {
        width: 100px;
        height: 100px;
        margin: 0 auto;
        position: relative;
    }
    
    .checkmark__circle {
        stroke-dasharray: 166;
        stroke-dashoffset: 166;
        stroke-width: 2;
        stroke-miterlimit: 10;
        stroke: #4CAF50;
        fill: none;
        animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }
    
    .checkmark__check {
        transform-origin: 50% 50%;
        stroke-dasharray: 48;
        stroke-dashoffset: 48;
        stroke: #4CAF50;
        animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }
    
    @keyframes stroke {
        100% {
            stroke-dashoffset: 0;
        }
    }
    
    @keyframes scale {
        0%, 100% {
            transform: none;
        }
        50% {
            transform: scale3d(1.1, 1.1, 1);
        }
    }
    
    .confetti-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
    }
    
    .confetti {
        position: absolute;
        width: 10px;
        height: 20px;
        opacity: 0;
    }
    
    .order-details-card {
        border-left: 4px solid #0A1F44;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .timeline {
        position: relative;
        padding-left: 30px;
        margin: 30px 0;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #0A1F44;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 30px;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -34px;
        top: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #0A1F44;
        border: 3px solid white;
        box-shadow: 0 0 0 3px rgba(10, 31, 68, 0.2);
    }
    
    .timeline-item.active::before {
        background: #FF8C00;
        box-shadow: 0 0 0 3px rgba(255, 140, 0, 0.2);
    }
    
    .receipt-card {
        background: white;
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        position: relative;
        overflow: hidden;
    }
    
    .receipt-header {
        background: linear-gradient(135deg, #0A1F44 0%, #1a2f5d 100%);
        color: white;
        padding: 20px;
        text-align: center;
    }
    
    .receipt-watermark {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 120px;
        color: rgba(10, 31, 68, 0.1);
        font-weight: bold;
        white-space: nowrap;
        pointer-events: none;
    }
    
    .action-buttons .btn {
        transition: all 0.3s ease;
    }
    
    .action-buttons .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .delivery-estimation {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-left: 4px solid #2196F3;
    }
    
    .package-animation {
        width: 100px;
        height: 100px;
        margin: 0 auto;
        position: relative;
    }
    
    .package {
        width: 80px;
        height: 60px;
        background: #FF8C00;
        border-radius: 10px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: float 3s ease-in-out infinite;
    }
    
    .package::before {
        content: '';
        position: absolute;
        width: 90px;
        height: 15px;
        background: #0A1F44;
        top: -7px;
        left: -5px;
        border-radius: 5px;
    }
    
    @keyframes float {
        0%, 100% {
            transform: translate(-50%, -50%) translateY(0);
        }
        50% {
            transform: translate(-50%, -50%) translateY(-20px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5 order-confirmation-container">
    <!-- Success Animation -->
    <div class="row justify-content-center mb-5">
        <div class="col-lg-8">
            <div class="card border-0 shadow-lg position-relative overflow-hidden">
                <!-- Confetti Container -->
                <div class="confetti-container" id="confetti-container"></div>
                
                <div class="card-body text-center py-5">
                    <!-- Success Checkmark -->
                    <div class="success-animation mb-4">
                        <svg class="checkmark" viewBox="0 0 52 52">
                            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                        </svg>
                    </div>
                    
                    <!-- Package Animation (Alternative) -->
                    <!-- <div class="package-animation mb-4">
                        <div class="package"></div>
                    </div> -->
                    
                    <h1 class="text-primary mb-3">Order Placed Successfully!</h1>
                    <p class="lead text-secondary mb-4">
                        Thank you for your purchase. Your order has been confirmed and is being processed.
                    </p>
                    
                    <!-- Order Details Card -->
                    <div class="card order-details-card border-0 mb-4">
                        <div class="card-body p-4">
                            <div class="row align-items-center">
                                <div class="col-md-6 text-md-start mb-3 mb-md-0">
                                    <h4 class="text-primary mb-1">Order ID: {{ order.order_number }}</h4>
                                    <p class="text-muted mb-0">
                                        <i class="fas fa-calendar-alt me-2"></i>
                                        {{ order.created_at.strftime('%d %B, %Y %I:%M %p') }}
                                    </p>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <h3 class="text-success mb-0">₹{{ "%.2f"|format(order.total_amount) }}</h3>
                                    <small class="text-muted">Total Amount</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delivery Estimation -->
                    <div class="delivery-estimation rounded p-4 mb-4">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-shipping-fast fa-3x text-primary"></i>
                            </div>
                            <div>
                                <h5 class="mb-1">Estimated Delivery</h5>
                                <p class="h4 mb-0">
                                    {{ (order.created_at + timedelta(days=3)).strftime('%A, %d %B %Y') }}
                                </p>
                                <small class="text-muted">Usually arrives in 3-5 business days</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="action-buttons d-flex flex-wrap justify-content-center gap-3 mb-4">
                        <a href="{{ url_for('user.order_detail', order_id=order.id) }}" 
                           class="btn btn-primary btn-lg">
                            <i class="fas fa-eye me-2"></i>View Order Details
                        </a>
                        <button class="btn btn-outline-primary btn-lg" data-bs-toggle="modal" 
                                data-bs-target="#trackingModal">
                            <i class="fas fa-map-marker-alt me-2"></i>Track Order
                        </button>
                        <a href="{{ url_for('shop.products') }}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-shopping-cart me-2"></i>Continue Shopping
                        </a>
                    </div>
                    
                    <!-- Share & Download Options -->
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-share-alt me-2"></i>Share & Save
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <button class="btn btn-outline-primary w-100" id="share-order">
                                                <i class="fas fa-share me-2"></i>Share Order
                                            </button>
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-outline-success w-100" id="print-receipt">
                                                <i class="fas fa-print me-2"></i>Print Receipt
                                            </button>
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-outline-danger w-100" id="download-invoice">
                                                <i class="fas fa-file-pdf me-2"></i>Download Invoice
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order Timeline -->
    <div class="row justify-content-center mb-5">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Order Timeline
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item active">
                            <h6 class="text-primary">Order Placed</h6>
                            <p class="text-muted mb-2">
                                Your order has been successfully placed and confirmed.
                            </p>
                            <small class="text-muted">{{ order.created_at.strftime('%I:%M %p') }}</small>
                        </div>
                        <div class="timeline-item">
                            <h6>Order Confirmed</h6>
                            <p class="text-muted mb-2">
                                Your order will be confirmed shortly.
                            </p>
                            <small class="text-muted">Pending</small>
                        </div>
                        <div class="timeline-item">
                            <h6>Order Packed</h6>
                            <p class="text-muted mb-2">
                                Your items will be packed securely.
                            </p>
                            <small class="text-muted">Pending</small>
                        </div>
                        <div class="timeline-item">
                            <h6>Order Shipped</h6>
                            <p class="text-muted mb-2">
                                Your order will be shipped with tracking information.
                            </p>
                            <small class="text-muted">Pending</small>
                        </div>
                        <div class="timeline-item">
                            <h6>Order Delivered</h6>
                            <p class="text-muted mb-2">
                                Estimated delivery: 
                                {{ (order.created_at + timedelta(days=3)).strftime('%d %B') }}
                            </p>
                            <small class="text-muted">Pending</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order Summary -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card receipt-card">
                <!-- Watermark -->
                <div class="receipt-watermark">AutoSpareHub</div>
                
                <!-- Receipt Header -->
                <div class="receipt-header">
                    <h3 class="mb-2">
                        <i class="fas fa-car"></i> Auto<span>SpareHub</span>
                    </h3>
                    <p class="mb-0">INVOICE</p>
                </div>
                
                <div class="card-body">
                    <!-- Order & Customer Info -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-primary">Order Information</h6>
                            <p class="mb-1"><strong>Order ID:</strong> {{ order.order_number }}</p>
                            <p class="mb-1"><strong>Order Date:</strong> {{ order.created_at.strftime('%d %B, %Y') }}</p>
                            <p class="mb-1"><strong>Status:</strong> 
                                <span class="badge bg-primary">{{ order.order_status|title }}</span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Customer Information</h6>
                            <p class="mb-1"><strong>Name:</strong> {{ order.user.name }}</p>
                            <p class="mb-1"><strong>Email:</strong> {{ order.user.email }}</p>
                            {% if order.user.phone %}
                            <p class="mb-1"><strong>Phone:</strong> {{ order.user.phone }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Shipping Address -->
                    <div class="mb-4">
                        <h6 class="text-primary">Shipping Address</h6>
                        <div class="bg-light p-3 rounded">
                            <p class="mb-1">{{ order.address.full_name }}</p>
                            <p class="mb-1">{{ order.address.address_line1 }}</p>
                            {% if order.address.address_line2 %}
                            <p class="mb-1">{{ order.address.address_line2 }}</p>
                            {% endif %}
                            <p class="mb-1">{{ order.address.city }}, {{ order.address.state }} - {{ order.address.postal_code }}</p>
                            <p class="mb-0">{{ order.address.country }}</p>
                        </div>
                    </div>
                    
                    <!-- Order Items -->
                    <h6 class="text-primary mb-3">Order Items</h6>
                    <div class="table-responsive mb-4">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Product</th>
                                    <th class="text-center">Quantity</th>
                                    <th class="text-end">Price</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order.items %}
                                <tr>
                                    <td>
                                        <strong>{{ item.product_name }}</strong><br>
                                        <small class="text-muted">Part #: {{ item.part_number }}</small>
                                    </td>
                                    <td class="text-center">{{ item.quantity }}</td>
                                    <td class="text-end">₹{{ "%.2f"|format(item.unit_price) }}</td>
                                    <td class="text-end">₹{{ "%.2f"|format(item.total_price) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Subtotal</strong></td>
                                    <td class="text-end">₹{{ "%.2f"|format(order.subtotal) }}</td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="text-end">Tax (GST)</td>
                                    <td class="text-end">₹{{ "%.2f"|format(order.tax_amount) }}</td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="text-end">Shipping</td>
                                    <td class="text-end">₹{{ "%.2f"|format(order.shipping_amount) }}</td>
                                </tr>
                                <tr class="table-active">
                                    <td colspan="3" class="text-end"><strong>Grand Total</strong></td>
                                    <td class="text-end">
                                        <strong class="h5 text-primary">₹{{ "%.2f"|format(order.total_amount) }}</strong>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- Payment Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Payment Information</h6>
                            <div class="bg-light p-3 rounded">
                                <p class="mb-2">
                                    <strong>Method:</strong> 
                                    {% if order.payment_method == 'cod' %}
                                    Cash on Delivery
                                    {% else %}
                                    Online Payment
                                    {% endif %}
                                </p>
                                <p class="mb-0">
                                    <strong>Status:</strong> 
                                    <span class="badge {% if order.payment_status == 'paid' %}bg-success{% elif order.payment_status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ order.payment_status|title }}
                                    </span>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Customer Support</h6>
                            <div class="bg-light p-3 rounded">
                                <p class="mb-2">
                                    <i class="fas fa-envelope text-primary me-2"></i>
                                    support@autosparehub.com
                                </p>
                                <p class="mb-0">
                                    <i class="fas fa-phone text-primary me-2"></i>
                                    +1 (555) 123-4567
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer Note -->
                    <div class="text-center mt-4 pt-4 border-top">
                        <p class="text-muted small mb-2">
                            Thank you for shopping with AutoSpareHub!
                        </p>
                        <p class="text-muted small mb-0">
                            This is a computer generated invoice. No signature required.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tracking Modal -->
<div class="modal fade" id="trackingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Order Tracking - {{ order.order_number }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if order.tracking_number %}
                <div class="alert alert-info">
                    <i class="fas fa-shipping-fast me-2"></i>
                    <strong>Tracking Number:</strong> {{ order.tracking_number }}
                </div>
                {% endif %}
                
                <div class="tracking-steps">
                    <div class="step active">
                        <div class="step-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="step-content">
                            <h6>Order Placed</h6>
                            <p class="text-muted mb-0">{{ order.created_at.strftime('%d %b, %I:%M %p') }}</p>
                        </div>
                    </div>
                    <div class="step {% if order.order_status in ['confirmed', 'packed', 'shipped', 'delivered'] %}active{% endif %}">
                        <div class="step-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="step-content">
                            <h6>Order Confirmed</h6>
                            <p class="text-muted mb-0">
                                {% if order.order_status in ['confirmed', 'packed', 'shipped', 'delivered'] %}
                                {{ (order.created_at + timedelta(minutes=30)).strftime('%d %b, %I:%M %p') }}
                                {% else %}Pending{% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="step {% if order.order_status in ['packed', 'shipped', 'delivered'] %}active{% endif %}">
                        <div class="step-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="step-content">
                            <h6>Packed</h6>
                            <p class="text-muted mb-0">
                                {% if order.order_status in ['packed', 'shipped', 'delivered'] %}
                                {{ (order.created_at + timedelta(hours=2)).strftime('%d %b, %I:%M %p') }}
                                {% else %}Pending{% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="step {% if order.order_status in ['shipped', 'delivered'] %}active{% endif %}">
                        <div class="step-icon">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <div class="step-content">
                            <h6>Shipped</h6>
                            <p class="text-muted mb-0">
                                {% if order.order_status in ['shipped', 'delivered'] %}
                                {{ (order.created_at + timedelta(hours=4)).strftime('%d %b, %I:%M %p') }}
                                {% if order.tracking_number %}<br>Tracking: {{ order.tracking_number }}{% endif %}
                                {% else %}Pending{% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="step {% if order.order_status == 'delivered' %}active{% endif %}">
                        <div class="step-icon">
                            <i class="fas fa-home"></i>
                        </div>
                        <div class="step-content">
                            <h6>Delivered</h6>
                            <p class="text-muted mb-0">
                                {% if order.order_status == 'delivered' %}
                                {{ (order.created_at + timedelta(days=3)).strftime('%d %b, %I:%M %p') }}
                                {% else %}
                                Estimated: {{ (order.created_at + timedelta(days=3)).strftime('%d %b, %I:%M %p') }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>Delivery Instructions</h6>
                    <div class="alert alert-light">
                        <ul class="mb-0">
                            <li>Please keep your phone accessible for delivery updates</li>
                            <li>If you're not available, the package will be left at your doorstep</li>
                            <li>Check the package for any damage before accepting</li>
                            <li>Contact support immediately if there are any issues</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="get-updates">
                    <i class="fas fa-bell me-2"></i>Get Updates
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .tracking-steps {
        display: flex;
        justify-content: space-between;
        position: relative;
        margin: 40px 0;
    }
    
    .tracking-steps::before {
        content: '';
        position: absolute;
        top: 25px;
        left: 0;
        right: 0;
        height: 2px;
        background: #dee2e6;
        z-index: 1;
    }
    
    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
        flex: 1;
    }
    
    .step-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
        color: #6c757d;
        font-size: 20px;
        transition: all 0.3s ease;
    }
    
    .step.active .step-icon {
        background: #0A1F44;
        color: white;
        box-shadow: 0 0 0 5px rgba(10, 31, 68, 0.2);
    }
    
    .step-content {
        text-align: center;
    }
    
    .step.active .step-content h6 {
        color: #0A1F44;
        font-weight: 600;
    }
    
    @media (max-width: 768px) {
        .tracking-steps {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .tracking-steps::before {
            top: 0;
            left: 25px;
            width: 2px;
            height: 100%;
        }
        
        .step {
            flex-direction: row;
            margin-bottom: 30px;
            width: 100%;
        }
        
        .step-icon {
            margin-right: 20px;
            margin-bottom: 0;
        }
        
        .step-content {
            text-align: left;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Create confetti effect
        createConfetti();
        
        // Initialize success animation
        initSuccessAnimation();
        
        // Initialize button handlers
        initButtonHandlers();
        
        // Initialize timeline animation
        initTimelineAnimation();
    });
    
    /**
     * Create confetti effect
     */
    function createConfetti() {
        const container = document.getElementById('confetti-container');
        if (!container) return;
        
        const colors = ['#FF8C00', '#0A1F44', '#28A745', '#DC3545', '#FFC107', '#17A2B8'];
        const confettiCount = 50;
        
        for (let i = 0; i < confettiCount; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            
            // Random properties
            const color = colors[Math.floor(Math.random() * colors.length)];
            const size = Math.random() * 10 + 5;
            const left = Math.random() * 100;
            const animationDuration = Math.random() * 3 + 2;
            const animationDelay = Math.random() * 2;
            
            confetti.style.cssText = `
                width: ${size}px;
                height: ${size * 2}px;
                left: ${left}%;
                background-color: ${color};
                opacity: 0;
                animation: confettiFall ${animationDuration}s ease-in ${animationDelay}s forwards;
            `;
            
            container.appendChild(confetti);
        }
        
        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes confettiFall {
                0% {
                    opacity: 0;
                    transform: translateY(-100px) rotate(0deg);
                }
                10% {
                    opacity: 1;
                }
                100% {
                    opacity: 0;
                    transform: translateY(1000px) rotate(720deg);
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    /**
     * Initialize success animation
     */
    function initSuccessAnimation() {
        const checkmark = document.querySelector('.checkmark');
        if (checkmark) {
            // Animation is handled by CSS
            setTimeout(() => {
                checkmark.style.animation = 'scale 0.3s ease-in-out 1.5s both';
            }, 1500);
        }
    }
    
    /**
     * Initialize button handlers
     */
    function initButtonHandlers() {
        // Print receipt
        document.getElementById('print-receipt').addEventListener('click', function() {
            printReceipt();
        });
        
        // Download invoice
        document.getElementById('download-invoice').addEventListener('click', function() {
            downloadInvoice();
        });
        
        // Share order
        document.getElementById('share-order').addEventListener('click', function() {
            shareOrder();
        });
        
        // Get updates
        document.getElementById('get-updates')?.addEventListener('click', function() {
            getOrderUpdates();
        });
    }
    
    /**
     * Print receipt
     */
    function printReceipt() {
        const receiptCard = document.querySelector('.receipt-card');
        
        // Store original styles
        const originalBody = document.body.innerHTML;
        const originalStyles = document.head.innerHTML;
        
        // Create print window
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Invoice - {{ order.order_number }}</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        margin: 0;
                        padding: 20px;
                        color: #333;
                    }
                    .invoice-container {
                        max-width: 800px;
                        margin: 0 auto;
                        background: white;
                    }
                    .invoice-header {
                        text-align: center;
                        margin-bottom: 30px;
                        padding-bottom: 20px;
                        border-bottom: 2px solid #0A1F44;
                    }
                    .invoice-header h1 {
                        color: #0A1F44;
                        margin-bottom: 10px;
                    }
                    .order-info {
                        margin-bottom: 20px;
                    }
                    .order-info strong {
                        color: #0A1F44;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 20px 0;
                    }
                    th {
                        background: #0A1F44;
                        color: white;
                        padding: 10px;
                        text-align: left;
                    }
                    td {
                        padding: 10px;
                        border-bottom: 1px solid #ddd;
                    }
                    .total-row {
                        font-weight: bold;
                        background: #f8f9fa;
                    }
                    .footer {
                        text-align: center;
                        margin-top: 30px;
                        padding-top: 20px;
                        border-top: 1px solid #ddd;
                        font-size: 12px;
                        color: #666;
                    }
                    @media print {
                        @page {
                            margin: 0.5in;
                        }
                        .no-print {
                            display: none !important;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="invoice-container">
                    ${receiptCard.outerHTML}
                </div>
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(function() {
                            window.close();
                        }, 500);
                    };
                <\/script>
            </body>
            </html>
        `);
        printWindow.document.close();
    }
    
    /**
     * Download invoice as PDF
     */
    function downloadInvoice() {
        const element = document.querySelector('.receipt-card');
        const opt = {
            margin: [10, 10, 10, 10],
            filename: `AutoSpareHub_Invoice_${Date.now()}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2,
                useCORS: true,
                logging: true
            },
            jsPDF: { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'portrait' 
            }
        };
        
        // Show loading
        const button = document.getElementById('download-invoice');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating PDF...';
        button.disabled = true;
        
        html2pdf().set(opt).from(element).save()
            .then(() => {
                showNotification('Invoice downloaded successfully!', 'success');
            })
            .catch(error => {
                console.error('PDF generation error:', error);
                showNotification('Failed to generate PDF', 'error');
            })
            .finally(() => {
                button.innerHTML = originalHTML;
                button.disabled = false;
            });
    }
    
    /**
     * Share order
     */
    function shareOrder() {
        const orderId = '{{ order.order_number }}';
        const total = '₹{{ "%.2f"|format(order.total_amount) }}';
        const url = window.location.href;
        const text = `I just placed an order on AutoSpareHub! Order ID: ${orderId}, Total: ${total}`;
        
        if (navigator.share) {
            navigator.share({
                title: `AutoSpareHub Order: ${orderId}`,
                text: text,
                url: url
            })
            .then(() => console.log('Order shared successfully'))
            .catch(error => console.log('Error sharing:', error));
        } else {
            // Fallback: Copy to clipboard
            navigator.clipboard.writeText(text + '\n\n' + url)
                .then(() => {
                    showNotification('Order details copied to clipboard!', 'success');
                })
                .catch(err => {
                    console.error('Failed to copy:', err);
                    showNotification('Failed to copy order details', 'error');
                });
        }
    }
    
    /**
     * Get order updates
     */
    function getOrderUpdates() {
        const button = document.getElementById('get-updates');
        const originalHTML = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Subscribing...';
        button.disabled = true;
        
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    showNotification('You will receive updates about your order!', 'success');
                    
                    // Subscribe to push notifications
                    subscribeToPushNotifications();
                } else {
                    showNotification('You can enable notifications in browser settings.', 'info');
                }
                
                button.innerHTML = originalHTML;
                button.disabled = false;
            });
        } else if ('Notification' in window && Notification.permission === 'granted') {
            showNotification('You are already subscribed to updates!', 'info');
            button.innerHTML = originalHTML;
            button.disabled = false;
        } else {
            showNotification('Notifications are blocked. Please enable them in browser settings.', 'warning');
            button.innerHTML = originalHTML;
            button.disabled = false;
        }
    }
    
    /**
     * Subscribe to push notifications
     */
    async function subscribeToPushNotifications() {
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            try {
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array('{{ VAPID_PUBLIC_KEY }}')
                });
                
                // Send subscription to server
                await fetch('/notifications/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(subscription)
                });
                
                console.log('Subscribed to push notifications');
                
            } catch (error) {
                console.error('Failed to subscribe to push notifications:', error);
            }
        }
    }
    
    /**
     * VAPID key conversion
     */
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/\-/g, '+')
            .replace(/_/g, '/');
        
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }
    
    /**
     * Initialize timeline animation
     */
    function initTimelineAnimation() {
        const timelineItems = document.querySelectorAll('.timeline-item');
        let delay = 0;
        
        timelineItems.forEach((item, index) => {
            setTimeout(() => {
                item.style.opacity = '0';
                item.style.transform = 'translateY(20px)';
                item.style.transition = 'all 0.5s ease';
                
                setTimeout(() => {
                    item.style.opacity = '1';
                    item.style.transform = 'translateY(0)';
                }, 100);
            }, delay);
            
            delay += 300;
        });
    }
    
    /**
     * Show notification
     */
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show`;
        notification.innerHTML = `
            <i class="fas fa-${getNotificationIcon(type)} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    function getNotificationIcon(type) {
        const icons = {
            'success': 'check-circle',
            'error': 'exclamation-circle',
            'warning': 'exclamation-triangle',
            'info': 'info-circle'
        };
        return icons[type] || 'info-circle';
    }
</script>
{% endblock %}