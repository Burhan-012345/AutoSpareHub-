{% extends "base.html" %}

{% block title %}Shopping Cart - AutoSpareHub{% endblock %}

{% block extra_css %}
<style>
    .cart-item {
        transition: all 0.3s ease;
    }
    
    .cart-item.removing {
        opacity: 0;
        transform: translateX(-100px);
    }
    
    .quantity-control {
        width: 120px;
    }
    
    .quantity-input {
        width: 50px;
        text-align: center;
        border: 1px solid #dee2e6;
    }
    
    .item-image {
        width: 100px;
        height: 100px;
        object-fit: contain;
        border-radius: 8px;
        background: #f8f9fa;
        padding: 5px;
    }
    
    .empty-cart {
        min-height: 400px;
    }
    
    .summary-card {
        position: sticky;
        top: 20px;
    }
    
    .promo-code {
        position: relative;
    }
    
    .promo-code .btn {
        position: absolute;
        right: 0;
        top: 0;
        height: 100%;
        border-radius: 0 5px 5px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="mb-1">Shopping Cart</h1>
                    <p class="text-muted mb-0">
                        {% if cart_items %}
                            {{ cart_items|length }} item{% if cart_items|length > 1 %}s{% endif %} in your cart
                        {% endif %}
                    </p>
                </div>
                <a href="{{ url_for('shop.products') }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>Continue Shopping
                </a>
            </div>
            
            {% if cart_items %}
            <!-- Cart Items -->
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 100px;">Product</th>
                                    <th>Details</th>
                                    <th class="text-center">Quantity</th>
                                    <th class="text-end">Price</th>
                                    <th class="text-end">Total</th>
                                    <th style="width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody id="cart-items-body">
                                {% for item in cart_items %}
                                <tr class="cart-item align-middle" data-item-id="{{ item.id }}" id="cart-item-{{ item.id }}">
                                    <!-- Product Image -->
                                    <td>
                                        <a href="{{ url_for('shop.product_detail', slug=item.product.slug) }}">
                                            <img src="{{ item.product.primary_image }}" 
                                                 alt="{{ item.product.name }}"
                                                 class="item-image">
                                        </a>
                                    </td>
                                    
                                    <!-- Product Details -->
                                    <td>
                                        <div>
                                            <a href="{{ url_for('shop.product_detail', slug=item.product.slug) }}" 
                                               class="text-decoration-none text-dark fw-semibold">
                                                {{ item.product.name }}
                                            </a>
                                            <div class="text-muted small mt-1">
                                                Part #: {{ item.product.part_number }}
                                            </div>
                                            {% if item.product.vehicle_brand %}
                                            <div class="text-primary small">
                                                <i class="fas fa-car me-1"></i>
                                                {{ item.product.vehicle_brand.name }}
                                                {% if item.product.vehicle_model %}
                                                | {{ item.product.vehicle_model.name }}
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                            <!-- Stock Status -->
                                            <div class="mt-2">
                                                {% if item.product.is_in_stock %}
                                                    {% if item.product.stock_quantity <= 10 %}
                                                    <small class="text-warning">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                                        Only {{ item.product.stock_quantity }} left
                                                    </small>
                                                    {% else %}
                                                    <small class="text-success">
                                                        <i class="fas fa-check-circle me-1"></i>
                                                        In Stock
                                                    </small>
                                                    {% endif %}
                                                {% else %}
                                                    <small class="text-danger">
                                                        <i class="fas fa-times-circle me-1"></i>
                                                        Out of Stock
                                                    </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    
                                    <!-- Quantity -->
                                    <td class="text-center">
                                        <div class="d-inline-flex align-items-center quantity-control">
                                            <button class="btn btn-outline-secondary btn-sm quantity-minus" 
                                                    onclick="updateQuantity({{ item.id }}, -1)">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number" class="form-control form-control-sm quantity-input" 
                                                   value="{{ item.quantity }}" min="1" 
                                                   max="{{ item.product.stock_quantity }}"
                                                   id="quantity-{{ item.id }}"
                                                   onchange="updateQuantityInput({{ item.id }}, this.value)">
                                            <button class="btn btn-outline-secondary btn-sm quantity-plus" 
                                                    onclick="updateQuantity({{ item.id }}, 1)">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                        <div class="mt-1">
                                            <small class="text-muted">
                                                Max: {{ item.product.stock_quantity }}
                                            </small>
                                        </div>
                                    </td>
                                    
                                    <!-- Unit Price -->
                                    <td class="text-end">
                                        <div class="h6 mb-0">
                                            ₹{{ "%.2f"|format(item.product.discounted_price) }}
                                        </div>
                                        {% if item.product.discount > 0 %}
                                        <small class="text-muted text-decoration-line-through">
                                            ₹{{ "%.2f"|format(item.product.price) }}
                                        </small>
                                        <small class="text-success">
                                            Save {{ item.product.discount }}%
                                        </small>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Total Price -->
                                    <td class="text-end">
                                        <div class="h6 mb-0 item-total" id="item-total-{{ item.id }}">
                                            ₹{{ "%.2f"|format(item.product.discounted_price * item.quantity) }}
                                        </div>
                                    </td>
                                    
                                    <!-- Remove Button -->
                                    <td class="text-end">
                                        <button class="btn btn-link text-danger remove-from-cart" 
                                                onclick="removeFromCart({{ item.id }})"
                                                title="Remove item">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Cart Actions -->
            <div class="d-flex justify-content-between mt-4">
                <div>
                    <a href="{{ url_for('shop.products') }}" class="btn btn-outline-primary">
                        <i class="fas fa-shopping-bag me-2"></i>Continue Shopping
                    </a>
                </div>
                <div>
                    <button class="btn btn-outline-secondary me-2" onclick="clearCart()">
                        <i class="fas fa-trash me-2"></i>Clear Cart
                    </button>
                    <button class="btn btn-primary" onclick="updateAllQuantities()">
                        <i class="fas fa-sync-alt me-2"></i>Update Cart
                    </button>
                </div>
            </div>
            
            {% else %}
            <!-- Empty Cart -->
            <div class="card empty-cart shadow-sm">
                <div class="card-body d-flex flex-column align-items-center justify-content-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-shopping-cart fa-4x text-muted"></i>
                    </div>
                    <h3 class="text-muted mb-3">Your cart is empty</h3>
                    <p class="text-muted text-center mb-4">
                        Looks like you haven't added any products to your cart yet.<br>
                        Start shopping to find great auto parts!
                    </p>
                    <div class="d-flex gap-3">
                        <a href="{{ url_for('shop.products') }}" class="btn btn-primary">
                            <i class="fas fa-shopping-bag me-2"></i>Browse Products
                        </a>
                        <a href="{{ url_for('shop.index') }}" class="btn btn-outline-primary">
                            <i class="fas fa-star me-2"></i>View Featured
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Recently Viewed -->
            {% if session.get('recently_viewed') %}
            <div class="mt-5">
                <h4 class="mb-3">Recently Viewed</h4>
                <div class="row">
                    {% for product_id in session.get('recently_viewed', [])[:4] %}
                        {% set product = get_product_by_id(product_id) %}
                        {% if product %}
                        <div class="col-md-3 col-6">
                            <div class="card border-0 shadow-sm h-100">
                                <a href="{{ url_for('shop.product_detail', slug=product.slug) }}">
                                    <img src="{{ product.primary_image }}" 
                                         class="card-img-top" 
                                         alt="{{ product.name }}"
                                         style="height: 120px; object-fit: contain; padding: 10px;">
                                </a>
                                <div class="card-body p-2">
                                    <h6 class="card-title small mb-1">
                                        <a href="{{ url_for('shop.product_detail', slug=product.slug) }}" 
                                           class="text-decoration-none text-dark">
                                            {{ product.name|truncate(40) }}
                                        </a>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-primary fw-bold">
                                            ₹{{ "%.2f"|format(product.discounted_price) }}
                                        </span>
                                        <button class="btn btn-sm btn-outline-primary add-to-cart" 
                                                data-product-id="{{ product.id }}">
                                            <i class="fas fa-cart-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card summary-card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                    <!-- Subtotal -->
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal</span>
                        <span id="cart-subtotal">₹{{ "%.2f"|format(subtotal) }}</span>
                    </div>
                    
                    <!-- Tax -->
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax (GST)</span>
                        <span id="cart-tax">₹{{ "%.2f"|format(tax_amount) }}</span>
                    </div>
                    
                    <!-- Shipping -->
                    <div class="d-flex justify-content-between mb-3">
                        <span>Shipping</span>
                        <span id="cart-shipping">₹{{ "%.2f"|format(shipping_amount) }}</span>
                    </div>
                    
                    <!-- Divider -->
                    <hr>
                    
                    <!-- Total -->
                    <div class="d-flex justify-content-between mb-4">
                        <span class="h5">Total</span>
                        <span class="h5 text-primary" id="cart-total">₹{{ "%.2f"|format(total) }}</span>
                    </div>
                    
                    <!-- Promo Code -->
                    <div class="mb-4">
                        <label class="form-label small text-muted">Have a promo code?</label>
                        <div class="input-group promo-code">
                            <input type="text" class="form-control" id="promo-code" 
                                   placeholder="Enter code">
                            <button class="btn btn-outline-primary" type="button" 
                                    onclick="applyPromoCode()">
                                Apply
                            </button>
                        </div>
                        <div id="promo-message" class="small mt-2"></div>
                    </div>
                    
                    <!-- Checkout Button -->
                    <div class="d-grid mb-3">
                        <a href="{{ url_for('cart.checkout') }}" class="btn btn-primary btn-lg">
                            <i class="fas fa-lock me-2"></i>Proceed to Checkout
                        </a>
                    </div>
                    
                    <!-- Security Info -->
                    <div class="text-center">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>
                            Secure checkout • SSL encrypted
                        </small>
                    </div>
                    
                    <!-- Payment Methods -->
                    <div class="mt-4 pt-3 border-top">
                        <p class="small text-muted mb-2">We accept:</p>
                        <div class="d-flex flex-wrap gap-2">
                            <i class="fab fa-cc-visa fa-2x text-primary"></i>
                            <i class="fab fa-cc-mastercard fa-2x text-primary"></i>
                            <i class="fab fa-cc-amex fa-2x text-primary"></i>
                            <i class="fab fa-cc-paypal fa-2x text-primary"></i>
                            <i class="fas fa-university fa-2x text-primary"></i>
                        </div>
                    </div>
                    
                    <!-- Guarantees -->
                    <div class="mt-4">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <small>30-day return policy</small>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <small>Free shipping on orders above ₹2000</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check text-success me-2"></i>
                            <small>Genuine parts guarantee</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Need Help? -->
            <div class="card mt-4 shadow-sm">
                <div class="card-body">
                    <h6 class="mb-3">
                        <i class="fas fa-question-circle me-2 text-primary"></i>
                        Need Help?
                    </h6>
                    <p class="small text-muted mb-3">
                        Our customer support team is here to help with your order.
                    </p>
                    <div class="d-grid gap-2">
                        <a href="tel:+15551234567" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-phone me-2"></i>Call Us
                        </a>
                        <a href="mailto:support@autosparehub.com" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-envelope me-2"></i>Email Us
                        </a>
                        <a href="#" class="btn btn-outline-primary btn-sm" 
                           data-bs-toggle="modal" data-bs-target="#chatModal">
                            <i class="fas fa-comments me-2"></i>Live Chat
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Modal -->
<div class="modal fade" id="chatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Live Chat Support</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4">
                    <i class="fas fa-headset fa-3x text-primary mb-3"></i>
                    <h5>Chat with us!</h5>
                    <p class="text-muted">
                        Our support team is available 24/7 to help with your order.
                    </p>
                    <button class="btn btn-primary">
                        <i class="fas fa-comment-dots me-2"></i>Start Chat
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Update quantity with buttons
    function updateQuantity(itemId, change) {
        const input = document.getElementById(`quantity-${itemId}`);
        let newQuantity = parseInt(input.value) + change;
        const max = parseInt(input.max) || 999;
        const min = parseInt(input.min) || 1;
        
        if (newQuantity >= min && newQuantity <= max) {
            input.value = newQuantity;
            updateCartItem(itemId, newQuantity);
        }
    }
    
    // Update quantity from input
    function updateQuantityInput(itemId, value) {
        const max = parseInt(document.getElementById(`quantity-${itemId}`).max) || 999;
        const min = parseInt(document.getElementById(`quantity-${itemId}`).min) || 1;
        
        let newQuantity = parseInt(value);
        if (isNaN(newQuantity) || newQuantity < min) {
            newQuantity = min;
        } else if (newQuantity > max) {
            newQuantity = max;
        }
        
        document.getElementById(`quantity-${itemId}`).value = newQuantity;
        updateCartItem(itemId, newQuantity);
    }
    
    // Update cart item via AJAX
    async function updateCartItem(itemId, quantity) {
        try {
            const response = await fetch(`/cart/update/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `quantity=${quantity}`
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update item total
                document.getElementById(`item-total-${itemId}`).textContent = 
                    `₹${data.item_total.toFixed(2)}`;
                
                // Update cart totals
                updateCartTotals();
                
                showNotification('Cart updated', 'success');
            } else {
                showNotification(data.message, 'error');
                // Reset to previous value
                const input = document.getElementById(`quantity-${itemId}`);
                input.value = input.defaultValue;
            }
        } catch (error) {
            console.error('Error updating cart:', error);
            showNotification('Failed to update cart', 'error');
        }
    }
    
    // Update all quantities
    function updateAllQuantities() {
        const inputs = document.querySelectorAll('.quantity-input');
        inputs.forEach(input => {
            const itemId = input.id.replace('quantity-', '');
            updateCartItem(itemId, input.value);
        });
    }
    
    // Remove item from cart
    async function removeFromCart(itemId) {
        if (!confirm('Are you sure you want to remove this item from your cart?')) {
            return;
        }
        
        const cartItem = document.getElementById(`cart-item-${itemId}`);
        cartItem.classList.add('removing');
        
        try {
            const response = await fetch(`/cart/remove/${itemId}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Remove from DOM after animation
                setTimeout(() => {
                    cartItem.remove();
                    
                    // Update cart count in navbar
                    updateCartCount(data.cart_count);
                    
                    // Update cart totals
                    updateCartTotals();
                    
                    // Check if cart is empty
                    if (data.cart_count === 0) {
                        location.reload();
                    }
                    
                    showNotification(data.message, 'success');
                }, 300);
            } else {
                showNotification(data.message, 'error');
                cartItem.classList.remove('removing');
            }
        } catch (error) {
            console.error('Error removing from cart:', error);
            showNotification('Failed to remove item', 'error');
            cartItem.classList.remove('removing');
        }
    }
    
    // Clear entire cart
    async function clearCart() {
        if (!confirm('Are you sure you want to clear your entire cart?')) {
            return;
        }
        
        const cartItems = document.querySelectorAll('.cart-item');
        
        try {
            // Remove all items one by one
            for (const item of cartItems) {
                const itemId = item.dataset.itemId;
                await removeFromCart(itemId);
            }
            
            showNotification('Cart cleared', 'success');
            
            // Reload page after clearing
            setTimeout(() => {
                location.reload();
            }, 1000);
            
        } catch (error) {
            console.error('Error clearing cart:', error);
            showNotification('Failed to clear cart', 'error');
        }
    }
    
    // Apply promo code
    async function applyPromoCode() {
        const promoCode = document.getElementById('promo-code').value.trim();
        const messageDiv = document.getElementById('promo-message');
        
        if (!promoCode) {
            messageDiv.innerHTML = '<span class="text-danger">Please enter a promo code</span>';
            return;
        }
        
        // Simulate promo code validation
        // In a real application, this would make an API call
        const validCodes = {
            'SAVE10': 10,
            'WELCOME20': 20,
            'FREESHIP': 'free_shipping'
        };
        
        if (validCodes[promoCode.toUpperCase()]) {
            const discount = validCodes[promoCode.toUpperCase()];
            
            if (typeof discount === 'number') {
                // Percentage discount
                messageDiv.innerHTML = `<span class="text-success">✅ ${discount}% discount applied!</span>`;
                applyPercentageDiscount(discount);
            } else if (discount === 'free_shipping') {
                // Free shipping
                messageDiv.innerHTML = '<span class="text-success">✅ Free shipping applied!</span>';
                applyFreeShipping();
            }
        } else {
            messageDiv.innerHTML = '<span class="text-danger">Invalid promo code</span>';
        }
    }
    
    // Apply percentage discount
    function applyPercentageDiscount(percentage) {
        const subtotal = parseFloat(document.getElementById('cart-subtotal').textContent.replace('₹', ''));
        const discount = subtotal * (percentage / 100);
        const total = parseFloat(document.getElementById('cart-total').textContent.replace('₹', ''));
        
        // Update display
        const discountRow = document.getElementById('discount-row');
        if (!discountRow) {
            const totalsDiv = document.querySelector('.card-body');
            const totalRow = document.querySelector('.d-flex.justify-content-between.mb-4');
            
            const discountHtml = `
                <div class="d-flex justify-content-between mb-2" id="discount-row">
                    <span>Discount (${percentage}%)</span>
                    <span class="text-success">-₹${discount.toFixed(2)}</span>
                </div>
            `;
            
            totalRow.insertAdjacentHTML('beforebegin', discountHtml);
        } else {
            discountRow.innerHTML = `
                <span>Discount (${percentage}%)</span>
                <span class="text-success">-₹${discount.toFixed(2)}</span>
            `;
        }
        
        // Update total
        const newTotal = total - discount;
        document.getElementById('cart-total').textContent = `₹${newTotal.toFixed(2)}`;
    }
    
    // Apply free shipping
    function applyFreeShipping() {
        const shipping = document.getElementById('cart-shipping');
        shipping.textContent = '₹0.00';
        
        // Update total
        const total = parseFloat(document.getElementById('cart-total').textContent.replace('₹', ''));
        const shippingCost = parseFloat('{{ shipping_amount }}');
        const newTotal = total - shippingCost;
        
        document.getElementById('cart-total').textContent = `₹${newTotal.toFixed(2)}`;
    }
    
    // Update cart totals from server
    async function updateCartTotals() {
        try {
            const response = await fetch('/api/cart/total');
            const data = await response.json();
            
            // Update totals
            document.getElementById('cart-subtotal').textContent = `₹${data.subtotal.toFixed(2)}`;
            document.getElementById('cart-tax').textContent = `₹${data.tax.toFixed(2)}`;
            document.getElementById('cart-shipping').textContent = `₹${data.shipping.toFixed(2)}`;
            document.getElementById('cart-total').textContent = `₹${data.total.toFixed(2)}`;
            
        } catch (error) {
            console.error('Error updating cart totals:', error);
        }
    }
    
    // Update cart count in navbar
    function updateCartCount(count) {
        const cartBadge = document.querySelector('.cart-count');
        const cartLink = document.querySelector('.cart-badge');
        
        if (count > 0) {
            if (cartBadge) {
                cartBadge.textContent = count;
            } else if (cartLink) {
                const badge = document.createElement('span');
                badge.className = 'cart-count';
                badge.textContent = count;
                cartLink.appendChild(badge);
            }
        } else if (cartBadge) {
            cartBadge.remove();
        }
    }
    
    // Show notification
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    // Add to cart from recently viewed
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', async function() {
            const productId = this.dataset.productId;
            
            try {
                const response = await fetch(`/cart/add/${productId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: 'quantity=1'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateCartCount(data.cart_count);
                    showNotification('Product added to cart!', 'success');
                    
                    // Update cart totals
                    updateCartTotals();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                showNotification('Failed to add to cart', 'error');
            }
        });
    });
</script>
{% endblock %}